// =========================
// PRISMA SCHEMA ‚Äî PRODUCTION READY
// =========================

// ---------- Generator ----------
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// ---------- Datasource ----------
datasource db {
  provider = "postgresql"
}

// =========================
// ENUMS
// =========================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Role {
  USER
  ASSISTANT
  SYSTEM
}

enum VerificationType {
  EMAIL_VERIFY
  MFA_OTP
  PASSWORD_RESET
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

// =========================
// USER & AUTH MODELS
// =========================

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String?
  image    String?
  country  String?

  role UserRole @default(USER)

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  mfaEnabled      Boolean   @default(true)

  // Relations
  chats          Chat[]
  sessions       Session[]
  accounts       Account[]
  trustedDevices TrustedDevice[]

  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
  payments      Payment[]

  @@index([email])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String

  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id     String @id @default(cuid())
  userId String

  providerId String
  accountId  String

  accessToken  String?
  refreshToken String?
  idToken      String?
  scope        String?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String           @id @default(cuid())
  identifier String
  value      String
  type       VerificationType
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
  @@map("verification")
}

// =========================
// CHAT MODELS
// =========================

model Chat {
  id     String @id @default(cuid())
  title  String
  userId String

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  isArchived  Boolean  @default(false)
  isStreaming Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("chat")
}

model ChatMessage {
  id      String @id @default(cuid())
  chatId  String
  role    Role
  content String

  // üóÇ versioning (SELF RELATION)
  version  Int           @default(1)
  parentId String?
  parent   ChatMessage?  @relation("MessageVersions", fields: [parentId], references: [id])
  children ChatMessage[] @relation("MessageVersions")

  // AI metadata
  model    String?
  tokens   Int?
  metadata Json?

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([chatId])
  @@index([chatId, createdAt])
  @@map("chat_message")
}

// =========================
// SECURITY MODELS
// =========================
model TrustedDevice {
  id        String   @id @default(cuid())
  userId    String
  hash      String
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("trusted_device")
}

model OtpAttempt {
  id       String    @id @default(cuid())
  email    String
  ip       String?
  attempts Int       @default(0)
  lockedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, ip])
  @@index([email])
  @@index([lockedAt])
  @@map("otp_attempt")
}

model Plan {
  id       String @id @default(cuid())
  name     String @unique
  price    Float // in cents
  currency String @default("INR")
  interval String // monthly / yearly

  isFree   Boolean @default(false) // ‚≠ê ADD THIS
  isActive Boolean @default(true)

  stripePriceId String?

  maxChats    Int?
  maxMessages Int?
  maxTokens   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  planId String

  status SubscriptionStatus

  startedAt DateTime
  endsAt    DateTime? // NULL for FREE

  // üîÅ PERIOD SYSTEM
  periodStart        DateTime
  periodIntervalDays Int // 7 for FREE, 30 for paid

  // PAYMENT (NULL for FREE)
  provider               String?
  providerSubscriptionId String?

  billingInterval String
  tokensRemaining Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  amount        Float // Stored in rupees (e.g., 199.00), not paise
  currency      String
  status        PaymentStatus
  provider      String
  providerTxnId String        @unique

  tokensRemaining Int?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

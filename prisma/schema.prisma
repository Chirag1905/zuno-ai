// =========================
// PRISMA SCHEMA â€” PRODUCTION READY
// =========================

// ---------- Generator ----------
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// ---------- Datasource ----------
datasource db {
  provider = "postgresql"
}

// =========================
// ENUMS
// =========================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum Role {
  USER
  ASSISTANT
  SYSTEM
}

enum VerificationType {
  EMAIL_VERIFY
  MFA_OTP
  PASSWORD_RESET
}

// =========================
// USER & AUTH MODELS
// =========================

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String?
  image    String?

  role UserRole @default(USER)

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  mfaEnabled      Boolean   @default(true)

  // Relations
  chats          Chat[]
  sessions       Session[]
  accounts       Account[]
  trustedDevices TrustedDevice[]

  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscriptions Subscription[]
  payments      Payment[]

  @@index([email])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String

  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id     String @id @default(cuid())
  userId String

  providerId String
  accountId  String

  accessToken  String?
  refreshToken String?
  idToken      String?
  scope        String?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String           @id @default(cuid())
  identifier String
  value      String
  type       VerificationType
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
  @@map("verification")
}

// =========================
// CHAT MODELS
// =========================

model Chat {
  id     String @id @default(cuid())
  title  String
  userId String

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("chat")
}

model ChatMessage {
  id      String @id @default(cuid())
  chatId  String
  role    Role
  content String

  //Optional future-proof fields
  // AI metadata (optional)
  model    String?
  tokens   Int?
  metadata Json?
  // e.g. gpt-4, llama3, mistral

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([chatId])
  @@index([chatId, createdAt])
  @@map("chat_message")
}

// =========================
// SECURITY MODELS
// =========================
model TrustedDevice {
  id        String   @id @default(cuid())
  userId    String
  hash      String
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("trusted_device")
}

model OtpAttempt {
  id       String    @id @default(cuid())
  email    String
  ip       String?
  attempts Int       @default(0)
  lockedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, ip])
  @@index([email])
  @@index([lockedAt])
  @@map("otp_attempt")
}

model Plan {
  id       String @id @default(cuid())
  name     String
  price    Int // in cents
  currency String @default("USD")
  interval String // monthly / yearly

  maxChats    Int?
  maxMessages Int?
  maxTokens   Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  planId String

  status    String // active, canceled, past_due
  startedAt DateTime
  endsAt    DateTime?

  provider               String // stripe, razorpay
  providerSubscriptionId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Payment {
  id            String @id @default(cuid())
  userId        String
  amount        Int
  currency      String
  status        String
  provider      String
  providerTxnId String

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
